<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/head') %>
    <title><%= post.title %> | 공군의 책방</title>
  </head>
  <body>
    <%- include('../partials/nav') %>

    <div class="container-fluid mb-3">
      <div class="card">
        <h5 class="card-header p-2"><%= post.title %></h5>
        <div class="row"> 

          <div class="col-md-7 col-lg-8 col-xl-9 order-sm-2 order-md-1">
            <pre><div class="post-body p-2"><%= post.body %></div></pre>
          </div>

          <div class="col-md-5 col-lg-4 col-xl-3 order-sm-1 order-md-2">
            <div class="post-info card m-2 p-2">
              <div class="border-bottom pb-1 mb-1"> <!-- 1 -->
                <span>Author</span><%= post.author ? post.author.username : "" %>
              </div>
              <div><span>작성일</span> : <span data-date-time="<%= post.createdAt %>"></span></div>
              <% if(post.updatedAt) { %>
                <div><span>수정일</span> : <span data-date-time="<%= post.updatedAt %>"></span></div>
              <% } %>
            </div>
          </div>

        </div>
      </div>

      <div class="mt-3">
        <a class="btn btn-primary" href="/books">돌아가기</a>
        <% if(isAuthenticated && post.author && currentUser.id == post.author.id){ %>
          <a class="btn btn-primary" href="/posts/<%= post._id %>/edit">수정</a>
          <form action="/posts/<%= post._id %>?_method=delete" method="post" class="d-inline">
            <a class="btn btn-primary" href="javascript:void(0)" onclick="confirm('Do you want to delete this?')?this.parentElement.submit():null;">삭제</a>
          </form>
        <% } %>
        <% if(isAuthenticated && post.likes.toString().indexOf(currentUser.id) < 0){ %>
          <form action="/posts/<%= post._id%>/like" method="post" class"d-inline">
            <button type="submit" class="btn btn-primary">좋아요</button>
          </form>
        <% } else if (isAuthenticated && post.likes.toString().indexOf(currentUser.id) >= 0){ %>
          <form action="/posts/<%= post._id%>/unlike" method="post" class"d-inline">
            <button type="submit" class="btn btn-primary">좋아요 취소</button>
          </form>
        <% } %>
      </div>
    </div>

    <% if(post.attachment) { %>
      <div class="audio-container fixed-bottom">
        <div class="audio-left">
          <div class="info">
            <%= post.author ? post.author.username : "" %> <%= post.title %> - <%= post.book.title %>
          </div>
          <div class="duration">
            <span id="now_time">00:00</span>
            <input type="range" min="0" max="100" value="0" id="duration_slider" onchange="change_duration()">
            <span id="total_time">00:00</span>
          </div>
        </div>
        <div class="audio-right">
          <button onclick="pre_10s()" id="pre"><span class="material-icons">replay_10</span></i>
          <button onclick="play()" id="play"><i class="fas fa-play"></i></button>
          <button onclick="next_30s()" id="next"><span class="material-icons">forward_30</span></button>
        </div>
      </div>
    <% } %>

    <script type="text/javascript">
      let prvious = document.querySelector('#pre');
      let play_btn = document.querySelector('#play');
      let next = document.querySelector('#next');
      let now_time = document.querySelector('#now_time');
      let total_time = document.querySelector('#total_time');
      let slider = document.querySelector('#duration_slider');

      let timer;

      let playing_song = false;
      let track = document.createElement('audio');

      if(isNaN(<%= post.attachment.serverFileName %>){
        let review_path = "/files/<%= post.attachment.serverFileName %>/<%= post.attachment.originalFileName %>"
      }

      function load_track(){
        track.src = review_path;
        track.load();
        timer = setInterval(range_slider, 1000)
      }

      load_track();

      function play(){
        if(playing_song == false){
          playsong();
        }else{
          pausesong();
        }
      }

      function playsong(){
        track.play();
        playing_song = true;
        play_btn.innerHTML = '<i class="fas fa-pause"></i>'
      }

      function pausesong(){
        track.pause();
        playing_song = false;
        play_btn.innerHTML = '<i class="fas fa-play"></i>'
      }
      
      function change_duration(){
        slider_position = track.duration * (slider.value / 100);
        track.currentTime = slider_position;
      }

      function range_slider(){
        let position = 0;

        if(!isNaN(track.duration)){
          let total_min = Math.round(track.duration/60);
          let total_sec = Math.round(track.duration % 60);
          if(total_min < 10) {
            total_min = "0" + total_min;
          }
          if(total_sec < 10) {
            total_sec = "0" + total_sec;
          }

          total_time.innerHTML = total_min + ":" + total_sec;
          position = track.currentTime * (100 / track.duration);
          slider.value = position;
        }

        let now_min = Math.round(track.currentTime/60);
        let now_sec = Math.round(track.currentTime % 60);
        if(now_min < 10) {
          now_min = "0" + now_min;
        }
        if(now_sec < 10) {
          now_sec = "0" + now_sec;
        }
        now_time.innerHTML = now_min + ":" + now_sec;
      }

      function pre_10s(){
        track.currentTime -= 10;
      }

      function next_30s(){
        track.currentTime -= 30;
      }

    </script>
  </body>
</html>